<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>证件扫描生成器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Custom font and body styling */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: #f0f2f5; /* Light gray background */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        /* Styling for the main container */
        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem; /* 12px */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 900px; /* Max width for the container */
        }
        /* Styling for the upload boxes */
        .upload-box {
            border: 2px dashed #d1d5db; /* gray-300 */
            border-radius: 0.5rem; /* 8px */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: border-color 0.3s;
            aspect-ratio: 16 / 10; /* Common ID card aspect ratio for placeholder */
            background-color: #f9fafb; /* gray-50 */
            position: relative; /* For absolute positioning of img */
        }
        .upload-box:hover {
            border-color: #3b82f6; /* blue-500 */
        }
        .upload-box img.preview-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* Show the whole image */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0.375rem; /* 6px */
        }
        /* Styling for the preview area */
        .preview-area {
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 0.5rem; /* 8px */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #f9fafb; /* gray-50 */
            min-height: 300px; /* Minimum height for preview */
            position: relative;
        }
        .preview-area canvas {
            max-width: 100%;
            max-height: 500px; /* Max height for canvas */
            object-fit: contain;
            border-radius: 0.375rem; /* 6px */
        }
        /* Styling for buttons */
        .action-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem; /* 6px */
            font-weight: 500;
            transition: background-color 0.3s;
            cursor: pointer;
        }
        .button-primary {
            background-color: #3b82f6; /* blue-500 */
            color: white;
        }
        .button-primary:hover {
            background-color: #2563eb; /* blue-600 */
        }
        .button-secondary {
            background-color: #6b7280; /* gray-500 */
            color: white;
        }
        .button-secondary:hover {
            background-color: #4b5563; /* gray-600 */
        }
        .button-success {
            background-color: #10b981; /* green-500 */
            color: white;
        }
        .button-success:hover {
            background-color: #059669; /* green-600 */
        }
        /* Icon styling */
        .upload-icon svg {
            width: 3rem; /* 48px */
            height: 3rem; /* 48px */
            color: #9ca3af; /* gray-400 */
            margin-bottom: 0.5rem;
        }
        /* Message box styling */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ef4444; /* red-500 */
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none; /* Hidden by default */
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-700 mb-8">证件扫描生成器</h1>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 items-start">
            <div id="upload-front-area" class="upload-box">
                <input type="file" id="upload-front-input" accept="image/*" class="hidden">
                <div class="text-center p-4">
                    <div class="upload-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                        </svg>
                    </div>
                    <p class="text-sm text-gray-500">点击上传身份证正面</p>
                </div>
                <img id="front-image-preview" src="#" alt="身份证正面预览" class="preview-image hidden" onerror="this.style.display='none'; this.parentElement.querySelector('.text-center').classList.remove('hidden');">
            </div>

            <div id="upload-back-area" class="upload-box">
                <input type="file" id="upload-back-input" accept="image/*" class="hidden">
                <div class="text-center p-4">
                    <div class="upload-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                        </svg>
                    </div>
                    <p class="text-sm text-gray-500">点击上传身份证背面</p>
                </div>
                <img id="back-image-preview" src="#" alt="身份证背面预览" class="preview-image hidden" onerror="this.style.display='none'; this.parentElement.querySelector('.text-center').classList.remove('hidden');">
            </div>

            <div class="preview-area md:col-span-1">
                 <div id="preview-placeholder" class="text-center p-4">
                    <div class="upload-icon">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                    <p class="text-sm text-gray-500">等待生成预览</p>
                </div>
                <canvas id="combined-preview-canvas" class="hidden"></canvas>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4 mt-8">
            <button id="reset-button" class="action-button button-secondary w-full sm:w-auto">重置</button>
            <button id="generate-preview-button" class="action-button button-primary w-full sm:w-auto">生成预览</button>
            <button id="download-pdf-button" class="action-button button-success hidden w-full sm:w-auto">下载PDF (A4排版)</button>
        </div>
    </div>

    <div id="message-box" class="message-box"></div>

    <script>
        // Ensure jsPDF is loaded
        const { jsPDF } = window.jspdf;

        // DOM Elements
        const uploadFrontArea = document.getElementById('upload-front-area');
        const uploadFrontInput = document.getElementById('upload-front-input');
        const frontImagePreview = document.getElementById('front-image-preview');

        const uploadBackArea = document.getElementById('upload-back-area');
        const uploadBackInput = document.getElementById('upload-back-input');
        const backImagePreview = document.getElementById('back-image-preview');

        const previewPlaceholder = document.getElementById('preview-placeholder');
        const combinedPreviewCanvas = document.getElementById('combined-preview-canvas');
        const ctx = combinedPreviewCanvas.getContext('2d');

        const resetButton = document.getElementById('reset-button');
        const generatePreviewButton = document.getElementById('generate-preview-button');
        const downloadPdfButton = document.getElementById('download-pdf-button');
        const messageBox = document.getElementById('message-box');

        // Store processed image data (DataURL and type)
        let frontImageData = null;
        let backImageData = null;

        // --- Message Box Functionality ---
        function showMessage(message, type = 'error') {
            messageBox.textContent = message;
            messageBox.style.backgroundColor = type === 'success' ? '#10b981' : '#ef4444'; // green-500 or red-500
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 3000);
        }

        // --- Process and Orient Image Function ---
        async function processAndOrientImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const originalDataUrl = e.target.result;
                    const img = new Image();

                    img.onload = () => {
                        const tempCanvas = document.createElement('canvas');
                        const tempCtx = tempCanvas.getContext('2d');

                        // Draw image to a temporary canvas. This often respects EXIF orientation.
                        tempCanvas.width = img.width;
                        tempCanvas.height = img.height;
                        tempCtx.drawImage(img, 0, 0);

                        // Get the dimensions of the image as drawn on the canvas
                        // These dimensions should reflect the visual orientation after EXIF handling
                        const drawnWidth = tempCanvas.width;
                        const drawnHeight = tempCanvas.height;

                        let finalCanvas = document.createElement('canvas');
                        let finalCtx = finalCanvas.getContext('2d');
                        let processedDataUrl;

                        // Check if the visually oriented image is portrait
                        if (drawnHeight > drawnWidth) {
                            // If portrait, rotate 90 degrees clockwise to make it landscape
                            finalCanvas.width = drawnHeight; // Swapped dimensions for rotation
                            finalCanvas.height = drawnWidth;
                            finalCtx.translate(finalCanvas.width / 2, finalCanvas.height / 2);
                            finalCtx.rotate(Math.PI / 2); // Rotate 90 degrees
                            finalCtx.drawImage(tempCanvas, -drawnWidth / 2, -drawnHeight / 2, drawnWidth, drawnHeight);
                             finalCtx.setTransform(1, 0, 0, 1, 0, 0); // Reset transform

                             processedDataUrl = finalCanvas.toDataURL(file.type);

                        } else {
                            // If landscape or square, use the temporary canvas directly
                            finalCanvas = tempCanvas;
                            processedDataUrl = finalCanvas.toDataURL(file.type);
                        }

                        // Clean up temporary canvas
                        tempCanvas.remove();
                        finalCanvas.remove(); // Remove the final canvas element from DOM (it's not attached)

                        resolve({ dataUrl: processedDataUrl, type: file.type });
                    };

                    img.onerror = reject; // Reject the promise on image load error
                    img.src = originalDataUrl;
                };

                reader.onerror = reject; // Reject the promise on file read error
                reader.readAsDataURL(file);
            });
        }


        // --- File Upload Logic ---
        function setupUploadArea(areaElement, inputElement, previewElement, dataVariableSetter) {
            areaElement.addEventListener('click', () => inputElement.click());
            inputElement.addEventListener('change', async (event) => { // Made async to use await
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    try {
                        // Process and orient the image
                        const processedData = await processAndOrientImage(file);

                        // Update the preview element with the processed image
                        previewElement.src = processedData.dataUrl;
                        previewElement.classList.remove('hidden');
                        areaElement.querySelector('.text-center').classList.add('hidden'); // Hide placeholder text/icon

                        // Store the processed image data
                        dataVariableSetter(processedData);

                        // Clear previous preview and hide download button
                        clearCombinedPreview();
                        downloadPdfButton.classList.add('hidden');

                    } catch (error) {
                        console.error("Image processing error:", error);
                        showMessage('图片处理失败，请尝试其他图片或格式。', 'error');
                        inputElement.value = ''; // Reset input
                        dataVariableSetter(null); // Clear stored data
                        previewElement.src = '#';
                        previewElement.classList.add('hidden');
                        areaElement.querySelector('.text-center').classList.remove('hidden');
                    }
                } else if (file) {
                    showMessage('请上传图片文件 (例如 JPG, PNG)。', 'error');
                    inputElement.value = ''; // Reset input
                    dataVariableSetter(null); // Clear stored data
                }
            });
        }

        setupUploadArea(uploadFrontArea, uploadFrontInput, frontImagePreview, (data) => frontImageData = data);
        setupUploadArea(uploadBackArea, uploadBackInput, backImagePreview, (data) => backImageData = data);

        // --- Clear Combined Preview ---
        function clearCombinedPreview() {
            if (combinedPreviewCanvas.width > 0 && combinedPreviewCanvas.height > 0) {
                ctx.clearRect(0, 0, combinedPreviewCanvas.width, combinedPreviewCanvas.height);
            }
            combinedPreviewCanvas.classList.add('hidden');
            previewPlaceholder.classList.remove('hidden');
        }

        // --- Reset Functionality ---
        resetButton.addEventListener('click', () => {
            frontImageData = null;
            backImageData = null;

            uploadFrontInput.value = '';
            frontImagePreview.src = '#';
            frontImagePreview.classList.add('hidden');
            uploadFrontArea.querySelector('.text-center').classList.remove('hidden');

            uploadBackInput.value = '';
            backImagePreview.src = '#';
            backImagePreview.classList.add('hidden');
            uploadBackArea.querySelector('.text-center').classList.remove('hidden');

            clearCombinedPreview();
            downloadPdfButton.classList.add('hidden');
            showMessage('已重置所有内容。', 'success');
        });

        // --- Generate Preview Functionality (Canvas Preview) ---
        generatePreviewButton.addEventListener('click', async () => {
            if (!frontImageData || !backImageData) {
                showMessage('请先上传身份证的正面和背面图片。', 'error');
                return;
            }

            previewPlaceholder.classList.add('hidden');
            combinedPreviewCanvas.classList.remove('hidden');

            const imgFront = new Image();
            const imgBack = new Image();

            // Load images from the stored processed DataURLs
            const loadFrontImage = new Promise(resolve => { imgFront.onload = resolve; imgFront.onerror = () => resolve(); imgFront.src = frontImageData.dataUrl; });
            const loadBackImage = new Promise(resolve => { imgBack.onload = resolve; imgBack.onerror = () => resolve(); imgBack.src = backImageData.dataUrl; });

            await Promise.all([loadFrontImage, loadBackImage]);

            // Check if images loaded successfully
            if (!imgFront.complete || imgFront.naturalHeight === 0 || !imgBack.complete || imgBack.naturalHeight === 0) {
                showMessage('图片加载失败，请尝试其他图片。', 'error');
                clearCombinedPreview();
                return;
            }

            // Canvas preview dimensions (approximate, for visual aid)
            // Scale images to fit horizontally within the preview area while maintaining aspect ratio
            const previewCanvasMaxWidth = combinedPreviewCanvas.parentElement.clientWidth * 0.95; // Max width for canvas
            // Since images are now pre-oriented to landscape, their width > height (or equal)
            const maxCardDisplayWidthPx = Math.min(350, previewCanvasMaxWidth / 1.1); // Max width for each card in preview, slightly less than half of max canvas width
            const previewVerticalSpacingPx = 20; // Spacing between cards in preview

            // Calculate display dimensions for each image based on its *processed* aspect ratio
            const displayFrontWidthPx = maxCardDisplayWidthPx;
            const displayFrontHeightPx = (imgFront.height / imgFront.width) * displayFrontWidthPx; // Use processed dimensions

            const displayBackWidthPx = maxCardDisplayWidthPx;
            const displayBackHeightPx = (imgBack.height / imgBack.width) * displayBackWidthPx; // Use processed dimensions

            // Set canvas dimensions to fit both images vertically with spacing
            combinedPreviewCanvas.width = maxCardDisplayWidthPx; // Canvas width is the width of a single displayed card
            combinedPreviewCanvas.height = displayFrontHeightPx + displayBackHeightPx + previewVerticalSpacingPx;

            // Clear canvas and set background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, combinedPreviewCanvas.width, combinedPreviewCanvas.height);

            // Draw images onto the canvas
            // Draw front image at the top
            ctx.drawImage(imgFront, 0, 0, displayFrontWidthPx, displayFrontHeightPx);
            // Draw back image below the front image with spacing
            ctx.drawImage(imgBack, 0, displayFrontHeightPx + previewVerticalSpacingPx, displayBackWidthPx, displayBackHeightPx);

            downloadPdfButton.classList.remove('hidden');
            showMessage('预览已生成！现在可以下载PDF。', 'success');
        });

        // --- Download PDF Functionality (A4 Layout) ---
        downloadPdfButton.addEventListener('click', async () => {
            if (!frontImageData || !backImageData) {
                showMessage('请先上传身份证正面和背面图片，并生成预览。', 'error');
                return;
            }

            try {
                const imgFront = new Image();
                const imgBack = new Image();

                // Load images from the stored processed DataURLs
                const loadFrontImage = new Promise((resolve, reject) => { imgFront.onload = resolve; imgFront.onerror = reject; imgFront.src = frontImageData.dataUrl; });
                const loadBackImage = new Promise((resolve, reject) => { imgBack.onload = resolve; imgBack.onerror = reject; imgBack.src = backImageData.dataUrl; });

                await Promise.all([loadFrontImage, loadBackImage]);

                 // Check if images loaded successfully
                if (!imgFront.complete || imgFront.naturalHeight === 0 || !imgBack.complete || imgBack.naturalHeight === 0) {
                    showMessage('图片加载失败，请尝试其他图片。', 'error');
                    return;
                }

                const pdf = new jsPDF({
                    orientation: 'p', // portrait
                    unit: 'mm',       // millimeters
                    format: 'a4'      // A4 page size
                });

                // Standard Chinese ID card dimensions in mm
                const cardActualWidthMM = 85.6;
                const cardActualHeightMM = 53.98;
                const scaleFactor = 1.1; // Scale factor for PDF output

                // Target dimensions for PDF based on standard card size, scaled
                // Since images are pre-oriented to landscape, we use these directly
                const pdfCardWidth = cardActualWidthMM * scaleFactor;
                const pdfCardHeight = cardActualHeightMM * scaleFactor;

                // A4 page dimensions in mm
                const a4WidthMM = pdf.internal.pageSize.getWidth();
                // const a4HeightMM = pdf.internal.pageSize.getHeight(); // For reference

                // Calculate horizontal position for centering
                const horizontalX = (a4WidthMM - pdfCardWidth) / 2;

                // Define vertical layout
                const topMarginMM = 20;         // Margin from the top of the PDF page
                const verticalSpacingMM = 15;   // Vertical spacing between the two cards

                const yPositionFront = topMarginMM;
                const yPositionBack = yPositionFront + pdfCardHeight + verticalSpacingMM;

                // Determine image format (JPEG or PNG) from stored data
                const frontFormat = frontImageData.type.includes('png') ? 'PNG' : 'JPEG';
                const backFormat = backImageData.type.includes('png') ? 'PNG' : 'JPEG';

                // Add front image to PDF using the target landscape dimensions
                // The image data is already oriented correctly
                pdf.addImage(imgFront, frontFormat, horizontalX, yPositionFront, pdfCardWidth, pdfCardHeight);

                // Add back image to PDF using the target landscape dimensions
                // The image data is already oriented correctly
                pdf.addImage(imgBack, backFormat, horizontalX, yPositionBack, pdfCardWidth, pdfCardHeight);

                // Save the PDF
                pdf.save('身份证扫描件_A4排版.pdf');
                showMessage('A4排版PDF已开始下载。', 'success');

            } catch (error) {
                console.error("PDF生成错误:", error);
                showMessage('生成PDF失败，请检查图片文件或查看控制台。', 'error');
            }
        });

    </script>
</body>
</html>
